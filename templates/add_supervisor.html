{% extends "layout.html" %}
{% block title %}إضافة/تعديل مشرف - نظام إدارة الطلاب{% endblock %}
{% block content %}
<div class="page-header">
    <a href="/supervisors" class="btn btn-secondary" onclick="RouteHandler.navigateTo('/supervisors'); return false;">
        <i class="fas fa-arrow-right"></i> رجوع
    </a>
    <h1>
        <i class="fas fa-user-tie"></i> إضافة / تعديل مشرف
    </h1>
</div>
<div class="card">
    <div class="card-body">
        <form id="addSupervisorForm" onsubmit="handleAddSupervisor(event)">
            <div class="form-group">
                <label for="fullName">الاسم الكامل *</label>
                <input id="fullName" name="full_name" class="form-control" required />
            </div>
            <div class="form-group">
                <label for="username">اسم المستخدم *</label>
                <input id="username" name="username" class="form-control" required />
            </div>
            <div class="form-group">
                <label for="emailUnivers">البريد الجامعي *</label>
                <input id="emailUnivers" name="emailunivers" type="email" class="form-control" required placeholder="example@university.com أو example@university.edu" />
                <small style="color:#888;">يجب أن ينتهي بالبقاء بـ <code>.com</code> أو <code>.edu</code></small>
            </div>
            <div class="form-group">
                <label for="password">كلمة المرور *</label>
                <div style="display:flex; gap:8px; align-items:center;">
                    <input id="password" name="password" type="password" class="form-control" required />
                    <button type="button" class="btn btn-secondary" style="padding:8px 12px;" onclick="togglePasswordVisibility()" title="إظهار/إخفاء كلمة المرور">
                        <i class="fas fa-eye" id="togglePasswordIcon"></i>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label for="phone">رقم الهاتف</label>
                <input id="phone" name="phone" class="form-control" />
            </div>
            <div class="form-group">
                <label for="roleField">الصلاحية</label>
                <select id="roleField" name="roles" class="form-control" style="width:220px;">
                    <option value="">-- اختر الصلاحية --</option>
                    <option value="كاملة">كاملة</option>
                    <option value="محدودة">محدودة</option>
                </select>
            </div>
            <div class="form-group">
                <label for="scientific">الرتبة العلمية</label>
                <select id="scientific" name="scientific_title" class="form-control">
                    <option value="">اختر</option>
                    <option>م.م.</option>
                    <option>أ.م.</option>
                    <option>أ.د.</option>
                    <option>م.د.</option>
                    <option>أ.م.د</option>
                </select>
            </div>
            <div class="form-group">
                <label>صورة المشرف (اختياري - اسحب وأسقط أو انقر للاختيار)</label>
                <div id="dropZone" style="border:2px dashed #2ecc71; border-radius:8px; padding:30px; text-align:center; cursor:pointer; transition:0.2s ease; background:#f9f9f9;">
                    <i class="fas fa-cloud-upload-alt" style="font-size:32px; color:#2ecc71; margin-bottom:12px;"></i>
                    <p style="margin:8px 0;">اسحب الصورة هنا أو انقر للاختيار</p>
                    <p style="margin:0; color:#888; font-size:12px;">صيغ مقبولة: JPG, PNG, GIF</p>
                </div>
                <input id="photoInput" name="photo" type="file" accept="image/*" style="display:none;" />
                <input type="hidden" id="photoData" name="photo_data" />
                <div id="photoPreview" style="display:none; margin-top:12px; text-align:center;">
                    <img id="photoImg" style="max-width:200px; max-height:200px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1);" />
                    <div style="margin-top:8px;">
                        <button type="button" class="btn btn-secondary btn-small" onclick="clearPhotoPreview()">
                            <i class="fas fa-times"></i> مسح الصورة
                        </button>
                    </div>
                </div>
            </div>
            <div style="display:flex; gap:10px; margin-top:12px;">
                <button class="btn btn-success" type="submit" id="saveBtn">حفظ</button>
                <a href="{{ url_for('supervisors') }}" class="btn btn-secondary">إلغاء</a>
            </div>
            <div id="saveSuccess" class="alert alert-success" style="display:none; margin-top:12px;">
                تم الحفظ بنجاح.
            </div>
            <div id="saveError" class="alert alert-danger" style="display:none; margin-top:12px;">
                حدث خطأ أثناء الحفظ.
            </div>
        </form>
    </div>
</div>
<script>
    // helper to read query param 'id'
    function getQueryParam(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
    }
    // toggle password visibility
    function togglePasswordVisibility(){
        const pwd = document.getElementById('password');
        const icon = document.getElementById('togglePasswordIcon');
        if (pwd.type === 'password') {
            pwd.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            pwd.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }
    let editingId = null;
    document.addEventListener('DOMContentLoaded', function(){
        const id = getQueryParam('id');
        setupDragAndDrop();
        // make role buttons keyboard accessible and initialize click/keydown handlers
        try{
            document.querySelectorAll('[data-role]').forEach(b=>{
                b.setAttribute('role','button');
                b.setAttribute('tabindex','0');
                b.setAttribute('aria-pressed','false');
                b.addEventListener('keydown', (e)=>{
                    if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); selectRole(b); }
                });
            });
            // if hidden field already has value (e.g., preserved after failed submit), highlight it
            const initial = (document.getElementById('roleField')||{}).value || '';
            if(initial){ const match = Array.from(document.querySelectorAll('[data-role]')).find(x=>x.getAttribute('data-role')===initial); if(match) selectRole(match); }
        }catch(e){}
        if (id && window.FirebaseReady) {
            window.FirebaseReady.then(api => {
                if (api.getUser) {
                    editingId = id;
                    api.getUser(id).then(u => {
                        if (!u) return;
                        document.getElementById('fullName').value = u.FullName || u.full_name || '';
                        document.getElementById('username').value = u.Username || u.username || '';
                        document.getElementById('phone').value = u.PhoneNumber || u.phone || '';
                        document.getElementById('scientific').value = u.Scientific_title || u.scientific_title || '';
                        const r = u.Roles || u.roles || '';
                        if (r) { document.getElementById('roleField').value = r; }
                        // populate university email if present
                        try{ document.getElementById('emailUnivers').value = u.emailunivers || u.Email || u.email || ''; }catch(e){}
                        // prefill password if available
                        try{ document.getElementById('password').value = u.Password || u.password || ''; }catch(e){}
                        // load photo if present
                        if (u.photo || u.Photo) {
                            const p = u.photo || u.Photo;
                            try{ document.getElementById('photoData').value = p; document.getElementById('photoImg').src = p; document.getElementById('photoPreview').style.display = 'block'; }catch(e){}
                        }
                            // mark role button: remove highlight from all then set the matching one
                            try{
                                document.querySelectorAll('[data-role]').forEach(b=> b.classList.remove('btn-primary'));
                                const matchBtn = Array.from(document.querySelectorAll('[data-role]')).find(b=> b.getAttribute('data-role') === r);
                                if(matchBtn){
                                    // use existing selectRole to ensure hidden field and classes are consistent
                                    selectRole(matchBtn);
                                }
                            }catch(e){ console.warn('role highlight failed', e); }
                    }).catch(err => console.error('getUser failed', err));
                }
            }).catch(()=>{});
        }
    });
    // Drag and drop handlers (copied from add_instructor)
    function setupDragAndDrop(){
        const dropZone = document.getElementById('dropZone');
        const photoInput = document.getElementById('photoInput');
        if(!dropZone || !photoInput) return;
        dropZone.addEventListener('click', () => photoInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.background = '#e8f8f5';
            dropZone.style.borderColor = '#1abc9c';
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.style.background = '#f9f9f9';
            dropZone.style.borderColor = '#2ecc71';
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.background = '#f9f9f9';
            dropZone.style.borderColor = '#2ecc71';
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handlePhotoSelect(files[0]);
            }
        });
        photoInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handlePhotoSelect(e.target.files[0]);
            }
        });
    }
    function handlePhotoSelect(file){
        if (!file.type.startsWith('image/')) {
            alert('يرجى اختيار صورة');
            return;
        }
        const reader = new FileReader();
        reader.onload = function(e){
            const base64 = e.target.result;
            document.getElementById('photoData').value = base64;
            document.getElementById('photoImg').src = base64;
            document.getElementById('photoPreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
    function clearPhotoPreview(){
        try{ document.getElementById('photoData').value = ''; document.getElementById('photoInput').value = ''; document.getElementById('photoPreview').style.display = 'none'; }catch(e){}
    }
    function selectRole(btn){
        if(!btn) return;
        const role = btn.getAttribute('data-role') || '';
        const hidden = document.getElementById('roleField');
        if(hidden) hidden.value = role;
        const parent = btn.parentElement;
        if(parent){
            parent.querySelectorAll('button').forEach(b=>{
                b.classList.remove('btn-primary');
                b.setAttribute('aria-pressed','false');
            });
        }
        btn.classList.add('btn-primary');
        btn.setAttribute('aria-pressed','true');
    }
    function handleAddSupervisor(e){
        e.preventDefault();
        const data = {
            full_name: document.getElementById('fullName').value,
            username: document.getElementById('username').value,
            emailunivers: document.getElementById('emailUnivers').value,
            password: document.getElementById('password').value,
            phone: document.getElementById('phone').value,
            roles: document.getElementById('roleField').value,
            scientific_title: document.getElementById('scientific').value
        };
        // validate university email ends with .com or .edu
        try{
            const ev = (data.emailunivers||'').toString().trim().toLowerCase();
            if(!ev || !/^[^@\s]+@[^@\s]+\.(com|edu)$/.test(ev)){
                document.getElementById('saveError').style.display='block';
                document.getElementById('saveError').textContent = 'الرجاء إدخال بريد جامعي صحيح ينتهي بـ .com أو .edu';
                return;
            }
        }catch(e){}
        // include photo if provided
        try{ const p = document.getElementById('photoData').value; if(p) data.photo = p; }catch(e){}
        if (editingId && window.FirebaseAPI && window.FirebaseAPI.updateUser) {
            const updatePayload = {
                FullName: data.full_name,
                Username: data.username,
                emailunivers: data.emailunivers,
                Email: data.emailunivers,
                Password: data.password,
                PhoneNumber: data.phone,
                Roles: data.roles,
                Scientific_title: data.scientific_title
            };
            if(data.photo) { updatePayload.Photo = data.photo; updatePayload.photo = data.photo; }
            window.FirebaseAPI.updateUser(editingId, updatePayload).then(()=>{
                document.getElementById('saveSuccess').style.display='block';
                setTimeout(()=>{ window.location.href = '{{ url_for("supervisors") }}'; }, 900);
            }).catch(err=>{ console.error(err); document.getElementById('saveError').style.display='block'; });
            return;
        }
        if (window.FirebaseAPI && window.FirebaseAPI.addUser) {
            // ensure addUser receives photo under common keys
            const addPayload = Object.assign({}, data);
            if(addPayload.emailunivers){ addPayload.Email = addPayload.emailunivers; }
            if(data.photo){ addPayload.Photo = data.photo; addPayload.photo = data.photo; }
            window.FirebaseAPI.addUser(addPayload).then(id=>{
                document.getElementById('saveSuccess').style.display='block';
                setTimeout(()=>{ RouteHandler.navigateTo('/supervisors'); }, 900);
            }).catch(err=>{ console.error(err); document.getElementById('saveError').style.display='block'; });
            return;
        }
        // fallback: attempt server
        fetch('/api/add-supervisor', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data) })
            .then(r=>r.json()).then(j=>{
                if (j.success) { document.getElementById('saveSuccess').style.display='block'; setTimeout(()=>{ RouteHandler.navigateTo('/supervisors'); },900);} else { document.getElementById('saveError').style.display='block'; }
            }).catch(err=>{ console.error(err); document.getElementById('saveError').style.display='block'; });
    }
</script>
{% endblock %}
